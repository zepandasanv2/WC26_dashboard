name: Notify Discord on GitHub Events

on:
  push:
  issues:
  pull_request:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Set notification variables
        id: set_vars
        shell: bash
        run: |
          set -e

          if [ "${{ github.event_name }}" = "push" ]; then
            TITLE="ðŸš€ Nouveau push sur le dÃ©pÃ´t !"
            COLOR=5763719
            DESC="**Auteur** : ${{ github.actor }}
**Branche** : \`${{ github.ref_name }}\`
**Message** : ${{ github.event.head_commit.message }}
[ðŸ”— Voir le commit](${{ github.event.head_commit.url }})"
          fi

          if [ "${{ github.event_name }}" = "issues" ]; then
            if [ "${{ github.event.action }}" = "opened" ]; then
              TITLE="ðŸ› Nouvelle issue"
              COLOR=15158332
            else
              TITLE="âœ… Issue fermÃ©e"
              COLOR=3066992
            fi

            DESC="**Titre** : ${{ github.event.issue.title }}
**Auteur** : ${{ github.event.issue.user.login }}
[ðŸ”— Voir l'issue](${{ github.event.issue.html_url }})"
          fi

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ github.event.action }}" = "opened" ]; then
              TITLE="ðŸ”€ Nouvelle Pull Request"
              COLOR=15844367
            elif [ "${{ github.event.pull_request.merged }}" = "true" ]; then
              TITLE="ðŸŽ‰ PR mergÃ©e"
              COLOR=65280
            else
              TITLE="âŒ PR fermÃ©e"
              COLOR=15105570
            fi

            DESC="**Titre** : ${{ github.event.pull_request.title }}
**Auteur** : ${{ github.event.pull_request.user.login }}
[ðŸ”— Voir la PR](${{ github.event.pull_request.html_url }})"
          fi

          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "color=$COLOR" >> "$GITHUB_OUTPUT"

          # IMPORTANT: sortie multi-ligne propre
          echo "description<<EOF" >> "$GITHUB_OUTPUT"
          echo "$DESC" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Build Discord JSON payload
        id: discord_json
        shell: bash
        run: |
          set -e

          jq -n \
            --arg title "${{ steps.set_vars.outputs.title }}" \
            --arg desc "${{ steps.set_vars.outputs.description }}" \
            --arg repo "${{ github.repository }}" \
            --arg actor "${{ github.actor }}" \
            --arg event "${{ github.event_name }}" \
            --argjson color ${{ steps.set_vars.outputs.color }} \
            '{
              username: "GitHub Actions",
              embeds: [
                {
                  title: $title,
                  description: $desc,
                  color: $color,
                  footer: { text: ("Repo: " + $repo + " â€¢ Event: " + $event + " â€¢ Actor: " + $actor) }
                }
              ]
            }' > payload.json

          echo "Payload generated:"
          cat payload.json

      - name: Send Discord notification
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: "$(cat payload.json)"
